generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  USER
  ADMIN
}

enum Team {
  TEAM_A
  TEAM_B
}

enum TournamentStatus {
  OPEN
  FULL
  COMPLETED
  CANCELLED
}

enum WithdrawalStatus {
  INITIATED
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

enum RiskFlagType {
  RAPID_DEPOSIT_WITHDRAW
  HIGH_WIN_RATE
  COLLUSION_SUSPECT
  MULTI_ACCOUNT_SUSPECT
  WITHDRAWAL_VELOCITY
}

enum RiskFlagSeverity {
  LOW
  MEDIUM
  HIGH
}

enum RiskFlagStatus {
  OPEN
  RESOLVED
}

enum UserSignalType {
  REGISTER
  LOGIN
  DEPOSIT
  WITHDRAW
}

enum FriendStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum SignupStatus {
  PENDING
  APPROVED
  WAITLISTED
}

enum DepositStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELED
}

enum TransactionType {
  DEPOSIT
  WITHDRAW
  WAGER_LOCK
  WAGER_RELEASE
  WAGER_WIN
  WAGER_LOSS
  WITHDRAW_LOCK
  WITHDRAW_COMPLETE
  WITHDRAW_RELEASE
  WITHDRAW_FEE
  MANUAL_CREDIT
  MANUAL_DEBIT
}

enum PlatformTransactionType {
  TOURNAMENT_FEE
  MANUAL_ADJUSTMENT
}

enum GameStatus {
  WAITING
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum GamePhase {
  WAITING
  DEALING
  BIDDING
  PLAYING
  SCORING
  GAME_COMPLETE
}

enum MoveType {
  DEAL
  BID
  PLAY_CARD
  END_HAND
  END_GAME
}

//////////////////////////////////////////////////////
// USER + WALLET
//////////////////////////////////////////////////////

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  avatarPreset String?
  avatarUrl   String?
  bio         String?
  isOnline    Boolean  @default(false)
  lastSeenAt  DateTime?
  signupStatus SignupStatus @default(APPROVED)
  signupRequestedAt DateTime?
  signupReviewedAt DateTime?
  signupReviewedBy String?

  stripeAccountId String? @unique
  stripeOnboarded Boolean @default(false)
  riskScore       Int     @default(0)
  withdrawalBlocked Boolean @default(false)
  isFrozen        Boolean @default(false)
  frozenAt        DateTime?
  frozenReason    String?

  disconnectCount  Int       @default(0)
  lastDisconnectAt DateTime?
  isSuspended      Boolean   @default(false)

  wallet      Wallet?
  deposits    Deposit[]
  depositHolds DepositHold[]
  riskFlags   RiskFlag[]
  signals     UserSignal[]
  withdrawals Withdrawal[]
  walletAdjustments WalletAdjustment[] @relation("AdminWalletAdjustments")
  adminAuditActions AdminActionAudit[] @relation("AdminActor")
  entries     TournamentEntry[]
  gamePlayers GamePlayer[]
  cards Card[]
  friendships Friend[] @relation("UserFriendships")
  friendOf Friend[]    @relation("UserFriendOf")
  adminNotifications AdminNotification[]
  adminEmailVerifications AdminEmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Decimal  @default(0.00)
  isFrozen  Boolean  @default(false)
  frozenAt  DateTime?
  frozenReason String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Ledger[]
  adjustments WalletAdjustment[]
}

model Ledger {
  id           String          @id @default(uuid())
  walletId     String
  wallet       Wallet          @relation(fields: [walletId], references: [id])
  type         TransactionType
  amount       Decimal
  balanceAfter Decimal
  reference    String?
  adminUserId  String?
  reason       String?
  createdAt    DateTime        @default(now())

  @@unique([reference, type])
  @@index([reference])
}

model WalletAdjustment {
  id          String   @id @default(uuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  adminUserId String
  adminUser   User     @relation("AdminWalletAdjustments", fields: [adminUserId], references: [id])
  amount      Decimal
  reason      String
  ledgerId    String?  @unique
  createdAt   DateTime @default(now())
}

model AppSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Friend {
  id         String      @id @default(uuid())
  userId     String
  friendId   String
  status     FriendStatus @default(PENDING)
  isTop      Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  acceptedAt DateTime?

  user   User @relation("UserFriendships", fields: [userId], references: [id])
  friend User @relation("UserFriendOf", fields: [friendId], references: [id])

  @@unique([userId, friendId])
  @@index([userId, status])
}

model AdminActionAudit {
  id         String   @id @default(uuid())
  adminUserId String
  action     String
  targetType String
  targetId   String
  reason     String?
  details    Json?
  createdAt  DateTime @default(now())

  adminUser User @relation("AdminActor", fields: [adminUserId], references: [id])

  @@index([adminUserId, createdAt])
  @@index([targetType, targetId, createdAt])
}

model AdminNotification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String
  payload   Json?
  status    String   @default("OPEN")
  readAt    DateTime?
  actedAt   DateTime?
  createdAt DateTime @default(now())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([status, createdAt])
  @@index([userId, createdAt])
}

model AdminEmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([expiresAt, usedAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([expiresAt, usedAt])
}

enum CardRarity {
  Common
  Rare
  Epic
  Legendary
}

model Card {
  id        String     @id @default(uuid())
  name      String
  rarity    CardRarity
  ownerId   String
  owner     User       @relation(fields: [ownerId], references: [id])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([ownerId, createdAt])
}


//////////////////////////////////////////////////////
// DEPOSITS / WITHDRAWALS
//////////////////////////////////////////////////////

model Deposit {
  id              String        @id @default(uuid())
  userId          String
  amount          Int
  status          DepositStatus @default(PENDING)
  stripeSessionId String?       @unique
  stripePaymentId String?       @unique
  idempotencyKey  String        @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])
  hold DepositHold?
}

model DepositHold {
  id              String   @id @default(uuid())
  userId          String
  depositId       String   @unique
  amount          Int
  remainingAmount Int
  releaseAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])

  @@index([userId, releaseAt])
}

model Withdrawal {
  id             String           @id @default(uuid())
  userId         String
  amount         Int
  fee            Int
  netAmount      Int
  status         WithdrawalStatus @default(INITIATED)
  stripePayoutId String?          @unique
  idempotencyKey String           @unique
  availableAt    DateTime
  processedAt    DateTime?
  retryCount     Int              @default(0)
  adminHold      Boolean          @default(false)
  adminHoldReason String?
  adminHoldAt    DateTime?
  adminHeldBy    String?
  riskScore      Int              @default(0)
  autoFlagged    Boolean          @default(false)
  createdAt      DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RiskFlag {
  id         String           @id @default(uuid())
  userId     String
  user       User             @relation(fields: [userId], references: [id])
  type       RiskFlagType
  severity   RiskFlagSeverity
  status     RiskFlagStatus   @default(OPEN)
  score      Int
  reason     String
  details    Json?
  createdAt  DateTime         @default(now())
  resolvedAt DateTime?

  @@index([userId, createdAt])
  @@index([status, severity, createdAt])
}

model UserSignal {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  type      UserSignalType
  ip        String?
  userAgent String?
  createdAt DateTime       @default(now())

  @@index([userId, createdAt])
  @@index([ip, userAgent, createdAt])
}

//////////////////////////////////////////////////////
// TOURNAMENTS
//////////////////////////////////////////////////////

model Tournament {
  id          String           @id @default(uuid())
  entryFee    Int
  maxPlayers  Int
  status      TournamentStatus @default(OPEN)
  totalPrize  Int              @default(0)
  platformFee Int              @default(0)
  createdAt   DateTime         @default(now())

  settled   Boolean   @default(false)
  settledAt DateTime?

  entries TournamentEntry[]
  games   Game[]
}

model TournamentEntry {
  id           String   @id @default(uuid())
  tournamentId String
  userId       String
  team         Team
  isWinner     Boolean  @default(false)
  createdAt    DateTime @default(now())

  tournament Tournament @relation(fields: [tournamentId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@unique([tournamentId, userId])
}

//////////////////////////////////////////////////////
// PLATFORM WALLET
//////////////////////////////////////////////////////

model PlatformWallet {
  id        String   @id @default(uuid())
  balance   Decimal  @default(0.00)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions PlatformLedger[]
}

model PlatformLedger {
  id           String                  @id @default(uuid())
  walletId     String
  wallet       PlatformWallet          @relation(fields: [walletId], references: [id])
  type         PlatformTransactionType
  amount       Decimal
  balanceAfter Decimal
  reference    String?
  createdAt    DateTime                @default(now())

  @@index([reference])
}

//////////////////////////////////////////////////////
// GAME ENGINE (SERVER-AUTHORITATIVE)
//////////////////////////////////////////////////////

model Game {
  id           String     @id @default(uuid())
  tournamentId String
  status       GameStatus @default(WAITING)
  phase        GamePhase  @default(WAITING)

  dealerSeat      Int
  currentTurnSeat Int

  teamAScore Int @default(0)
  teamBScore Int @default(0)
  teamASets  Int @default(0)
  teamBSets  Int @default(0)

  winnerTeam Team?

  state Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tournament Tournament   @relation(fields: [tournamentId], references: [id])
  players    GamePlayer[]
  hands      GameHand[]
  moves      GameMove[]
  moveAudits GameMoveAudit[]
}

model GamePlayer {
  id String @id @default(uuid())

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  team  Team
  seat  Int
  isBot Boolean @default(false)

  disconnectedAt DateTime?
  replacedByBot  Boolean   @default(false)

  createdAt DateTime @default(now())

  moves GameMove[]
}

model GameHand {
  id String @id @default(uuid())

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  handNumber Int

  teamABid Int
  teamBBid Int

  teamATricks Int @default(0)
  teamBTricks Int @default(0)

  teamAScoreDelta Int @default(0)
  teamBScoreDelta Int @default(0)

  createdAt DateTime @default(now())
}

model GameMove {
  id String @id @default(uuid())

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  playerId String
  player   GamePlayer @relation(fields: [playerId], references: [id])

  type    MoveType
  payload Json

  createdAt DateTime @default(now())
}

model GameMoveAudit {
  id        String   @id @default(uuid())
  gameId    String
  playerId  String?
  type      MoveType
  payload   Json
  createdAt DateTime @default(now())

  game Game @relation(fields: [gameId], references: [id])
}
